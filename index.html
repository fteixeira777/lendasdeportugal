<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no"/>
  <title>LENDAS DE PORTUGAL</title>
  <link href="https://fonts.googleapis.com/css2?family=Cinzel+Decorative:wght@400;700&family=Crimson+Pro:ital,wght@0,300;0,400;1,300&display=swap" rel="stylesheet"/>
  <style>
    *{box-sizing:border-box;margin:0;padding:0}
    :root{--gold:#c9a84c;--gold-light:#f0d080;--dark:#0a0705}
    body{font-family:'Crimson Pro',serif;background:var(--dark);color:#e8d9b0;height:100vh;overflow:hidden}

    .screen{position:fixed;inset:0;z-index:100;display:none;flex-direction:column;align-items:center;justify-content:center;gap:1.5rem;padding:2rem;background:var(--dark)}
    .screen.active{display:flex}
    .emblem{width:110px;height:110px;border:2px solid var(--gold);border-radius:50%;display:flex;align-items:center;justify-content:center;animation:spin 10s linear infinite}
    @keyframes spin{to{transform:rotate(360deg)}}
    .emblem svg{width:55px;height:55px}
    h1{font-family:'Cinzel Decorative',serif;font-size:1.3rem;color:var(--gold);text-align:center;line-height:1.5}
    .sub{font-style:italic;color:rgba(232,217,176,0.5);font-size:.9rem;text-align:center}
    .btn{font-family:'Cinzel Decorative',serif;font-size:.8rem;letter-spacing:.15em;padding:.9rem 2.5rem;border:1px solid var(--gold);background:transparent;color:var(--gold);cursor:pointer;transition:all .3s}
    .btn:active{background:var(--gold);color:var(--dark)}
    .hint{font-size:.65rem;color:rgba(232,217,176,0.25);text-align:center;line-height:1.8}

    #game{display:none;position:fixed;inset:0;flex-direction:column}
    #game.active{display:flex}
    #map-wrap{flex:1;position:relative;overflow:hidden;background:#0d0b08}
    canvas{position:absolute;inset:0;width:100%;height:100%}

    #debug{position:absolute;top:8px;left:8px;right:120px;font-family:monospace;font-size:.58rem;color:rgba(201,168,76,.85);background:rgba(10,7,5,.8);padding:6px 10px;border-radius:3px;line-height:1.9;pointer-events:none;z-index:10;border:1px solid rgba(201,168,76,.15)}
    #topright{position:absolute;top:8px;right:8px;text-align:right;z-index:10}
    .tokens-label{font-size:.55rem;letter-spacing:.1em;color:rgba(232,217,176,.4)}
    .tokens-val{font-family:'Cinzel Decorative',serif;font-size:1rem;color:var(--gold-light)}

    #panel{background:linear-gradient(to bottom,rgba(10,7,5,0),rgba(10,7,5,.98));padding:1rem 1.2rem 1.4rem}
    .row{display:flex;justify-content:space-between;align-items:center;margin-bottom:.4rem}
    .quest-tag{font-size:.58rem;letter-spacing:.2em;color:var(--gold);opacity:.7}
    .quest-name{font-family:'Cinzel Decorative',serif;font-size:.9rem;color:var(--gold-light);margin-bottom:.25rem}
    .quest-lore{font-style:italic;font-size:.82rem;color:rgba(232,217,176,.6);line-height:1.45;margin-bottom:.7rem}
    .dist-row{display:flex;align-items:center;gap:.7rem;margin-bottom:.7rem}
    .dist-label{font-size:.6rem;letter-spacing:.1em;color:rgba(232,217,176,.35);min-width:55px}
    .dist-bar{flex:1;height:2px;background:rgba(201,168,76,.12);border-radius:1px;overflow:hidden}
    .dist-fill{height:100%;background:var(--gold);transition:width .8s ease;width:0%}
    .dist-val{font-family:'Cinzel Decorative',serif;font-size:.72rem;color:var(--gold);min-width:48px;text-align:right}
    .poi-list{display:flex;gap:.5rem;overflow-x:auto;scrollbar-width:none;padding-bottom:2px}
    .poi-list::-webkit-scrollbar{display:none}
    .poi-card{flex-shrink:0;width:105px;border:1px solid rgba(201,168,76,.18);padding:.55rem;cursor:pointer;transition:all .2s;background:rgba(10,7,5,.5)}
    .poi-card.active{border-color:var(--gold);background:rgba(201,168,76,.07)}
    .poi-card.found{border-color:#4a9a5a;background:rgba(26,74,42,.2)}
    .poi-icon{font-size:1.2rem;margin-bottom:.15rem}
    .poi-name{font-size:.62rem;font-family:'Cinzel Decorative',serif;color:var(--gold-light);line-height:1.3}
    .poi-dist{font-size:.58rem;color:rgba(232,217,176,.3);margin-top:.1rem}
    .poi-found{font-size:.58rem;color:#4a9a5a;margin-top:.1rem}

    #found-popup{position:fixed;inset:0;z-index:200;background:rgba(10,7,5,.94);display:none;flex-direction:column;align-items:center;justify-content:center;gap:1.1rem;padding:2rem}
    #found-popup.show{display:flex}
    .found-glow{width:85px;height:85px;border-radius:50%;background:radial-gradient(circle,rgba(201,168,76,.2),transparent 70%);display:flex;align-items:center;justify-content:center;font-size:2.6rem;animation:glow 1.5s ease-in-out infinite}
    @keyframes glow{0%,100%{box-shadow:0 0 18px rgba(201,168,76,.15)}50%{box-shadow:0 0 45px rgba(201,168,76,.45)}}
    .found-title{font-family:'Cinzel Decorative',serif;font-size:1rem;color:var(--gold);text-align:center}
    .found-desc{font-style:italic;font-size:.88rem;color:rgba(232,217,176,.72);text-align:center;max-width:290px;line-height:1.55}
    .found-rl{font-size:.58rem;letter-spacing:.15em;color:rgba(201,168,76,.45);text-align:center}
    .found-rv{font-family:'Cinzel Decorative',serif;font-size:1.4rem;color:var(--gold-light);text-align:center}
  </style>
</head>
<body>

<div class="screen active" id="start-screen">
  <div class="emblem">
    <svg viewBox="0 0 60 60" fill="none">
      <path d="M30 5L30 55M5 30L55 30" stroke="#c9a84c" stroke-width="3" stroke-linecap="round"/>
      <path d="M30 5L30 55M5 30L55 30" stroke="#c9a84c" stroke-width="3" stroke-linecap="round" opacity=".3" transform="rotate(45 30 30)"/>
      <circle cx="30" cy="30" r="5" fill="#c9a84c" opacity=".7"/>
    </svg>
  </div>
  <h1>LENDAS<br/>DE PORTUGAL</h1>
  <p class="sub">Uncover the secrets of the old empire</p>
  <button class="btn" id="start-btn">BEGIN THE QUEST</button>
  <p class="hint">Allow location when asked.<br/>Best experienced outdoors on mobile.</p>
</div>

<div id="game">
  <div id="map-wrap">
    <canvas id="canvas"></canvas>
    <div id="debug">Requesting GPS...</div>
    <div id="topright">
      <div class="tokens-label">TOKENS</div>
      <div class="tokens-val" id="tokens">‚öú 0</div>
    </div>
  </div>
  <div id="panel">
    <div class="quest-tag">ACTIVE QUEST</div>
    <div class="quest-name" id="q-name">Waiting for location...</div>
    <div class="quest-lore" id="q-lore">Stand outside and allow location access.</div>
    <div class="dist-row">
      <span class="dist-label">Distance</span>
      <div class="dist-bar"><div class="dist-fill" id="dist-fill"></div></div>
      <span class="dist-val" id="dist-val">‚Äî m</span>
    </div>
    <div class="poi-list" id="poi-list"></div>
  </div>
</div>

<div id="found-popup">
  <div class="found-glow" id="f-icon">üóùÔ∏è</div>
  <div class="found-title" id="f-title"></div>
  <div class="found-desc" id="f-desc"></div>
  <div class="found-rl">TOKENS AWARDED</div>
  <div class="found-rv" id="f-reward"></div>
  <button class="btn" id="found-close">CONTINUE</button>
</div>

<script>
const QUESTS = [
  { id:'templar',   name:'The Templar Cipher',     icon:'‚öîÔ∏è',  tokens:50,  radius:25,
    desc:'"Seek the ancient seal near the fortress walls. The knights buried their secrets where the river meets the stone."',
    lore:'You found a Templar seal ‚Äî marked with the cross of the warrior monks who once guarded Portugal\'s frontier.',
    offset:{x:20,y:-20} },
  { id:'moorish',   name:'The Moorish Scroll',      icon:'üìú',  tokens:75,  radius:25,
    desc:'"In the shadow of the minaret turned church, a scroll waits for eyes that dare read the old tongue."',
    lore:'An ancient Arabic scroll describes the city before the Reconquista ‚Äî vibrant markets, fountains, a living world.',
    offset:{x:-90,y:150} },
  { id:'navigator', name:"The Navigator's Compass", icon:'üß≠',  tokens:100, radius:25,
    desc:'"Where the caravels were born, a compass points inward. Find it before the tide erases the mark."',
    lore:'A brass compass used by a navigator of the Age of Discovery ‚Äî it still points toward the unknown.',
    offset:{x:200,y:100} },
  { id:'star',      name:'The Hidden Star',          icon:'‚ú°Ô∏è',  tokens:80,  radius:25,
    desc:'"In the old Judiaria, carved where hands once lit hidden candles ‚Äî a six-pointed star endures."',
    lore:'A Star of David carved secretly by conversos during the Inquisition, hidden in plain sight for centuries.',
    offset:{x:-150,y:-120} }
];

// STATE
let totalTokens=0, found=new Set(), activeIdx=0, gpsCount=0;
let originLat=null, originLng=null;
let posX=0, posY=0;
let qPos=[];
let demoMode=false;
let keys={};
let W=0,H=0,canvas,ctx;
let lastTouch=null;
const SCALE=1.8;

// ‚îÄ‚îÄ START ‚îÄ‚îÄ
document.getElementById('start-btn').addEventListener('click', ()=>{
  document.getElementById('start-screen').classList.remove('active');
  document.getElementById('game').classList.add('active');
  setupCanvas();
  buildPOI();
  requestAnimationFrame(drawLoop);
  startGPS();
});

// ‚îÄ‚îÄ CANVAS ‚îÄ‚îÄ
function setupCanvas(){
  canvas=document.getElementById('canvas');
  ctx=canvas.getContext('2d');
  sizeCanvas();
  window.addEventListener('resize', sizeCanvas);
}
function sizeCanvas(){
  const wrap=document.getElementById('map-wrap');
  W=canvas.width=wrap.clientWidth;
  H=canvas.height=wrap.clientHeight;
}

// ‚îÄ‚îÄ GPS ‚Äî uses polling via getCurrentPosition (most reliable on iOS) ‚îÄ‚îÄ
function startGPS(){
  if(!navigator.geolocation){ startDemo(); return; }

  // Use BOTH watchPosition and polling ‚Äî whichever updates wins
  watchId = navigator.geolocation.watchPosition(
    pos => handleGPSPos(pos, 'watch'),
    err => console.log('watch err:', err.message),
    { enableHighAccuracy:true, timeout:10000, maximumAge:0 }
  );

  doGPSPoll();

  // Fallback to demo after 8s if no lock
  setTimeout(()=>{ if(!originLat) startDemo(); }, 8000);
}

let lastGPSTimestamp = 0;
let watchId = null;

function doGPSPoll(){
  navigator.geolocation.getCurrentPosition(
    pos => handleGPSPos(pos, 'poll'),
    err => {
      setDebug(`GPS err (${err.code}): ${err.message}`);
      if(!originLat) startDemo();
      else setTimeout(doGPSPoll, 2000);
    },
    { enableHighAccuracy:true, timeout:8000, maximumAge:500 }
  );
  setTimeout(doGPSPoll, 1500);
}

function handleGPSPos(pos, source) {
  gpsCount++;
  const lat=pos.coords.latitude;
  const lng=pos.coords.longitude;
  const acc=Math.round(pos.coords.accuracy);
  const ts=pos.timestamp;
  const ageMs=Date.now()-ts;
  const isFresh=ts>lastGPSTimestamp;
  if(isFresh) lastGPSTimestamp=ts;

  if(!originLat){
    originLat=lat; originLng=lng;
    posX=0; posY=0;
    placeQuests();
  } else {
    const newX=(lng-originLng)*111320*Math.cos(originLat*Math.PI/180);
    const newY=-((lat-originLat)*111320);
    // Only update if moved more than 1m (filter GPS jitter)
    if(Math.abs(newX-posX)>1 || Math.abs(newY-posY)>1){
      posX=newX; posY=newY;
    }
  }

  setDebug(`GPS ¬±${acc}m | ${source} #${gpsCount} | age:${(ageMs/1000).toFixed(0)}s<br>x: ${posX.toFixed(1)}m  y: ${posY.toFixed(1)}m<br>lat: ${lat.toFixed(6)}  lng: ${lng.toFixed(6)}<br>fresh: ${isFresh} | origin: ${originLat?'SET':'...'}`);
  checkProx(); updatePanel();
}

function startDemo(){
  if(demoMode) return;
  demoMode=true;
  originLat=38.7169; originLng=-9.1399;
  posX=0; posY=0;
  placeQuests();
  setDebug('DEMO MODE ‚Äî drag map to move');
}

function placeQuests(){
  qPos=QUESTS.map(q=>({x:q.offset.x, y:q.offset.y}));
  buildPOI(); updatePanel();
}

// ‚îÄ‚îÄ DISTANCE ‚îÄ‚îÄ
function dist(i){
  if(!qPos[i]) return 9999;
  const dx=qPos[i].x-posX, dy=qPos[i].y-posY;
  return Math.sqrt(dx*dx+dy*dy);
}

// ‚îÄ‚îÄ PROXIMITY ‚îÄ‚îÄ
function checkProx(){
  const q=QUESTS[activeIdx];
  if(!found.has(q.id) && dist(activeIdx)<q.radius) showFound(activeIdx);
}

function showFound(i){
  const q=QUESTS[i];
  found.add(q.id); totalTokens+=q.tokens;
  document.getElementById('f-icon').textContent=q.icon;
  document.getElementById('f-title').textContent=q.name.toUpperCase();
  document.getElementById('f-desc').textContent=q.lore;
  document.getElementById('f-reward').textContent=`+${q.tokens} ‚öú`;
  document.getElementById('found-popup').classList.add('show');
  buildPOI();
}

document.getElementById('found-close').addEventListener('click',()=>{
  document.getElementById('found-popup').classList.remove('show');
  for(let i=0;i<QUESTS.length;i++){ if(!found.has(QUESTS[i].id)){activeIdx=i;break;} }
  updatePanel(); buildPOI();
});

// ‚îÄ‚îÄ PANEL ‚îÄ‚îÄ
function updatePanel(){
  const q=QUESTS[activeIdx];
  document.getElementById('q-name').textContent=q.name;
  document.getElementById('q-lore').textContent=q.desc;
  document.getElementById('tokens').textContent=`‚öú ${totalTokens}`;
  const d=dist(activeIdx);
  document.getElementById('dist-fill').style.width=(d<9999?Math.max(0,Math.min(100,100-(d/300*100))):0)+'%';
  document.getElementById('dist-val').textContent=d<9999?`${Math.round(d)} m`:'‚Äî m';
  QUESTS.forEach((_,i)=>{
    const el=document.getElementById(`pd-${i}`);
    const d2=dist(i);
    if(el) el.textContent=d2<9999?`${Math.round(d2)} m`:'‚Äî m';
  });
}

function buildPOI(){
  const list=document.getElementById('poi-list');
  list.innerHTML='';
  QUESTS.forEach((q,i)=>{
    const isF=found.has(q.id), isA=i===activeIdx;
    const c=document.createElement('div');
    c.className=`poi-card${isA?' active':''}${isF?' found':''}`;
    c.innerHTML=`<div class="poi-icon">${q.icon}</div>
      <div class="poi-name">${q.name}</div>
      <div class="poi-dist" id="pd-${i}">‚Äî m</div>
      ${isF?'<div class="poi-found">‚úì FOUND</div>':''}`;
    c.onclick=()=>{ activeIdx=i; updatePanel(); buildPOI(); };
    list.appendChild(c);
  });
  updatePanel();
}

// ‚îÄ‚îÄ DRAW ‚îÄ‚îÄ
function drawLoop(){
  requestAnimationFrame(drawLoop);
  if(!W||!H) return;
  ctx.clearRect(0,0,W,H);
  const cx=W/2, cy=H/2, t=Date.now();

  // Grid
  ctx.strokeStyle='rgba(201,168,76,0.04)'; ctx.lineWidth=1;
  const gs=50;
  const ox=((cx-posX*SCALE)%gs+gs)%gs;
  const oy=((cy-posY*SCALE)%gs+gs)%gs;
  for(let x=ox;x<W;x+=gs){ctx.beginPath();ctx.moveTo(x,0);ctx.lineTo(x,H);ctx.stroke();}
  for(let y=oy;y<H;y+=gs){ctx.beginPath();ctx.moveTo(0,y);ctx.lineTo(W,y);ctx.stroke();}

  // Quests
  QUESTS.forEach((q,i)=>{
    if(!qPos[i]) return;
    const qx=cx+(qPos[i].x-posX)*SCALE;
    const qy=cy+(qPos[i].y-posY)*SCALE;
    const isF=found.has(q.id), isA=i===activeIdx;

    // Dashed line to active
    if(isA&&!isF){
      ctx.save(); ctx.setLineDash([4,6]);
      ctx.strokeStyle='rgba(201,168,76,0.1)'; ctx.lineWidth=1;
      ctx.beginPath(); ctx.moveTo(cx,cy); ctx.lineTo(qx,qy); ctx.stroke();
      ctx.restore();
    }

    // Pulse
    if(isA&&!isF){
      const p=0.5+0.5*Math.sin(t/500);
      ctx.beginPath(); ctx.arc(qx,qy,q.radius*SCALE*(1+p*0.35),0,Math.PI*2);
      ctx.strokeStyle=`rgba(201,168,76,${0.1*p})`; ctx.lineWidth=1; ctx.stroke();
    }

    // Radius
    ctx.beginPath(); ctx.arc(qx,qy,q.radius*SCALE,0,Math.PI*2);
    ctx.strokeStyle=isF?'rgba(74,154,90,0.2)':isA?'rgba(201,168,76,0.2)':'rgba(201,168,76,0.06)';
    ctx.lineWidth=1; ctx.stroke();
    ctx.fillStyle=isF?'rgba(74,154,90,0.04)':isA?'rgba(201,168,76,0.04)':'transparent';
    ctx.fill();

    // Marker
    ctx.beginPath(); ctx.arc(qx,qy,14,0,Math.PI*2);
    ctx.fillStyle=isF?'#0d2a12':isA?'rgba(201,168,76,0.12)':'rgba(10,7,5,0.85)';
    ctx.fill();
    ctx.strokeStyle=isF?'#4a9a5a':isA?'#c9a84c':'rgba(201,168,76,0.25)';
    ctx.lineWidth=isA?2:1; ctx.stroke();

    ctx.font='13px serif'; ctx.textAlign='center'; ctx.textBaseline='middle';
    ctx.fillText(q.icon,qx,qy);

    ctx.font='9px serif'; ctx.textBaseline='top';
    ctx.fillStyle=isF?'#4a9a5a':isA?'#c9a84c':'rgba(201,168,76,0.4)';
    ctx.fillText(q.name,qx,qy+17);
  });

  // Player
  const p2=0.5+0.5*Math.sin(t/350);
  ctx.beginPath(); ctx.arc(cx,cy,12+p2*2,0,Math.PI*2);
  ctx.strokeStyle=`rgba(201,168,76,${0.12*p2})`; ctx.lineWidth=2; ctx.stroke();
  ctx.beginPath(); ctx.arc(cx,cy,7,0,Math.PI*2);
  ctx.fillStyle='#c9a84c'; ctx.fill();
  ctx.strokeStyle='#f0d080'; ctx.lineWidth=1.5; ctx.stroke();
}

// ‚îÄ‚îÄ DEBUG ‚îÄ‚îÄ
function setDebug(html){ const el=document.getElementById('debug'); if(el) el.innerHTML=html; }

// ‚îÄ‚îÄ KEYBOARD ‚îÄ‚îÄ
document.addEventListener('keydown',e=>keys[e.key]=true);
document.addEventListener('keyup',e=>keys[e.key]=false);
setInterval(()=>{
  if(!demoMode) return;
  const spd=3; let moved=false;
  if(keys['ArrowUp']   ||keys['w']){posY-=spd;moved=true;}
  if(keys['ArrowDown'] ||keys['s']){posY+=spd;moved=true;}
  if(keys['ArrowLeft'] ||keys['a']){posX-=spd;moved=true;}
  if(keys['ArrowRight']||keys['d']){posX+=spd;moved=true;}
  if(moved){checkProx();updatePanel();}
},30);

// ‚îÄ‚îÄ TOUCH DRAG (demo) ‚îÄ‚îÄ
const mapWrap=document.getElementById('map-wrap');
mapWrap.addEventListener('touchstart',e=>{
  lastTouch={x:e.touches[0].clientX,y:e.touches[0].clientY};
},{passive:true});
mapWrap.addEventListener('touchmove',e=>{
  if(!lastTouch||!demoMode) return;
  const dx=e.touches[0].clientX-lastTouch.x;
  const dy=e.touches[0].clientY-lastTouch.y;
  posX-=dx/SCALE; posY-=dy/SCALE;
  lastTouch={x:e.touches[0].clientX,y:e.touches[0].clientY};
  checkProx(); updatePanel();
},{passive:true});
mapWrap.addEventListener('touchend',()=>lastTouch=null);
</script>
</body>
</html>
