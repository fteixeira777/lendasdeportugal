<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
  <title>LENDAS DE PORTUGAL ‚Äî AR Quest</title>
  <link href="https://fonts.googleapis.com/css2?family=Cinzel+Decorative:wght@400;700&family=Crimson+Pro:ital,wght@0,300;0,400;1,300&display=swap" rel="stylesheet" />

  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

    :root {
      --gold: #c9a84c;
      --gold-light: #f0d080;
      --dark: #0a0705;
      --parchment: #1a1208;
      --red: #8b1a1a;
      --green: #1a4a2a;
    }

    body {
      font-family: 'Crimson Pro', serif;
      background: var(--dark);
      color: #e8d9b0;
      height: 100vh;
      overflow: hidden;
      position: relative;
    }

    /* ‚îÄ‚îÄ LOADING SCREEN ‚îÄ‚îÄ */
    #loading-screen {
      position: fixed; inset: 0; z-index: 9999;
      background: var(--dark);
      display: flex; flex-direction: column;
      align-items: center; justify-content: center;
      gap: 2rem;
      transition: opacity 0.8s ease;
    }
    #loading-screen.hidden { opacity: 0; pointer-events: none; }

    .loading-emblem {
      width: 120px; height: 120px;
      border: 2px solid var(--gold);
      border-radius: 50%;
      display: flex; align-items: center; justify-content: center;
      position: relative;
      animation: rotate-slow 8s linear infinite;
    }
    .loading-emblem::before {
      content: '';
      position: absolute; inset: 8px;
      border: 1px solid rgba(201,168,76,0.3);
      border-radius: 50%;
    }
    .loading-emblem svg { width: 60px; height: 60px; }
    @keyframes rotate-slow { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }

    .loading-title {
      font-family: 'Cinzel Decorative', serif;
      font-size: 1.4rem;
      color: var(--gold);
      text-align: center;
      letter-spacing: 0.1em;
      line-height: 1.4;
    }
    .loading-subtitle {
      font-size: 1rem;
      color: rgba(232,217,176,0.6);
      font-style: italic;
      text-align: center;
    }

    .start-btn {
      background: transparent;
      border: 1px solid var(--gold);
      color: var(--gold);
      font-family: 'Cinzel Decorative', serif;
      font-size: 0.85rem;
      letter-spacing: 0.15em;
      padding: 1rem 2.5rem;
      cursor: pointer;
      transition: all 0.3s;
      position: relative;
      overflow: hidden;
    }
    .start-btn::before {
      content: '';
      position: absolute; inset: 0;
      background: var(--gold);
      transform: scaleX(0);
      transform-origin: left;
      transition: transform 0.3s ease;
      z-index: -1;
    }
    .start-btn:hover { color: var(--dark); }
    .start-btn:hover::before { transform: scaleX(1); }

    /* ‚îÄ‚îÄ MAIN GAME UI (overlaid on AR scene) ‚îÄ‚îÄ */
    #game-ui {
      position: fixed; inset: 0; z-index: 100;
      pointer-events: none;
      display: none;
    }
    #game-ui.active { display: block; }

    /* top bar */
    .top-bar {
      position: absolute; top: 0; left: 0; right: 0;
      padding: 1rem 1.5rem;
      display: flex; align-items: flex-start; justify-content: space-between;
      background: linear-gradient(to bottom, rgba(10,7,5,0.85), transparent);
      pointer-events: auto;
    }
    .game-title {
      font-family: 'Cinzel Decorative', serif;
      font-size: 0.75rem;
      color: var(--gold);
      letter-spacing: 0.15em;
      opacity: 0.8;
    }
    .score-area {
      text-align: right;
    }
    .score-label {
      font-size: 0.65rem;
      color: rgba(232,217,176,0.5);
      letter-spacing: 0.1em;
      text-transform: uppercase;
    }
    .score-value {
      font-family: 'Cinzel Decorative', serif;
      font-size: 1.1rem;
      color: var(--gold-light);
    }

    /* compass */
    .compass {
      position: absolute; top: 50%; right: 1.5rem;
      transform: translateY(-50%);
      width: 60px; height: 60px;
      pointer-events: none;
    }
    .compass-ring {
      width: 100%; height: 100%;
      border: 1px solid rgba(201,168,76,0.4);
      border-radius: 50%;
      display: flex; align-items: center; justify-content: center;
      position: relative;
    }
    .compass-needle {
      width: 2px; height: 24px;
      background: linear-gradient(to bottom, var(--red) 50%, #e8d9b0 50%);
      border-radius: 1px;
      transform-origin: center bottom;
      transition: transform 0.5s ease;
    }
    .compass-label {
      position: absolute; top: -18px; left: 50%;
      transform: translateX(-50%);
      font-size: 0.6rem; color: rgba(232,217,176,0.4);
      letter-spacing: 0.05em;
    }

    /* quest panel */
    .quest-panel {
      position: absolute; bottom: 0; left: 0; right: 0;
      padding: 1.5rem;
      background: linear-gradient(to top, rgba(10,7,5,0.95) 60%, transparent);
      pointer-events: auto;
    }
    .quest-tag {
      font-size: 0.6rem;
      letter-spacing: 0.2em;
      text-transform: uppercase;
      color: var(--gold);
      opacity: 0.7;
      margin-bottom: 0.4rem;
    }
    .quest-name {
      font-family: 'Cinzel Decorative', serif;
      font-size: 1rem;
      color: var(--gold-light);
      margin-bottom: 0.3rem;
    }
    .quest-desc {
      font-size: 0.9rem;
      font-style: italic;
      color: rgba(232,217,176,0.7);
      margin-bottom: 1rem;
      line-height: 1.5;
    }
    .distance-bar-wrap {
      display: flex; align-items: center; gap: 0.8rem;
      margin-bottom: 1rem;
    }
    .distance-label {
      font-size: 0.65rem;
      letter-spacing: 0.1em;
      color: rgba(232,217,176,0.5);
      min-width: 80px;
    }
    .distance-bar {
      flex: 1; height: 2px;
      background: rgba(201,168,76,0.15);
      border-radius: 1px;
      overflow: hidden;
    }
    .distance-fill {
      height: 100%;
      background: var(--gold);
      width: 0%;
      transition: width 1s ease;
    }
    .distance-val {
      font-family: 'Cinzel Decorative', serif;
      font-size: 0.75rem;
      color: var(--gold);
      min-width: 55px;
      text-align: right;
    }

    /* points of interest list */
    .poi-list {
      display: flex; gap: 0.8rem; overflow-x: auto;
      padding-bottom: 0.5rem;
      scrollbar-width: none;
    }
    .poi-list::-webkit-scrollbar { display: none; }
    .poi-card {
      flex-shrink: 0;
      width: 120px;
      border: 1px solid rgba(201,168,76,0.25);
      padding: 0.7rem;
      cursor: pointer;
      transition: all 0.3s;
      background: rgba(10,7,5,0.6);
    }
    .poi-card:hover, .poi-card.active {
      border-color: var(--gold);
      background: rgba(201,168,76,0.08);
    }
    .poi-card.found {
      border-color: var(--green);
      background: rgba(26,74,42,0.2);
    }
    .poi-icon { font-size: 1.5rem; margin-bottom: 0.3rem; }
    .poi-name {
      font-size: 0.7rem;
      font-family: 'Cinzel Decorative', serif;
      color: var(--gold-light);
      line-height: 1.3;
    }
    .poi-dist {
      font-size: 0.65rem;
      color: rgba(232,217,176,0.4);
      margin-top: 0.2rem;
    }
    .poi-found-badge {
      font-size: 0.6rem;
      color: #4a9a5a;
      margin-top: 0.2rem;
    }

    /* ‚îÄ‚îÄ FOUND POPUP ‚îÄ‚îÄ */
    #found-popup {
      position: fixed; inset: 0; z-index: 500;
      background: rgba(10,7,5,0.92);
      display: none; flex-direction: column;
      align-items: center; justify-content: center;
      gap: 1.5rem;
      padding: 2rem;
    }
    #found-popup.show { display: flex; }

    .found-glow {
      width: 100px; height: 100px;
      border-radius: 50%;
      background: radial-gradient(circle, rgba(201,168,76,0.3), transparent 70%);
      display: flex; align-items: center; justify-content: center;
      font-size: 3rem;
      animation: pulse-glow 1.5s ease-in-out infinite;
    }
    @keyframes pulse-glow {
      0%, 100% { box-shadow: 0 0 20px rgba(201,168,76,0.3); }
      50% { box-shadow: 0 0 50px rgba(201,168,76,0.6); }
    }
    .found-title {
      font-family: 'Cinzel Decorative', serif;
      font-size: 1.3rem;
      color: var(--gold);
      text-align: center;
    }
    .found-desc {
      font-size: 1rem;
      font-style: italic;
      color: rgba(232,217,176,0.8);
      text-align: center;
      max-width: 300px;
      line-height: 1.6;
    }
    .found-reward {
      font-family: 'Cinzel Decorative', serif;
      font-size: 1.5rem;
      color: var(--gold-light);
    }
    .found-reward-label {
      font-size: 0.7rem;
      letter-spacing: 0.15em;
      color: rgba(201,168,76,0.6);
      text-align: center;
    }
    .found-btn {
      background: var(--gold);
      border: none;
      color: var(--dark);
      font-family: 'Cinzel Decorative', serif;
      font-size: 0.8rem;
      letter-spacing: 0.1em;
      padding: 0.9rem 2rem;
      cursor: pointer;
      transition: background 0.2s;
    }
    .found-btn:hover { background: var(--gold-light); }

    /* ‚îÄ‚îÄ GPS STATUS ‚îÄ‚îÄ */
    .gps-status {
      position: absolute; top: 4rem; left: 1.5rem;
      font-size: 0.65rem;
      letter-spacing: 0.08em;
      color: rgba(232,217,176,0.4);
      display: flex; align-items: center; gap: 0.4rem;
    }
    .gps-dot {
      width: 6px; height: 6px; border-radius: 50%;
      background: #4a9a5a;
      animation: blink 2s ease-in-out infinite;
    }
    .gps-dot.searching { background: var(--gold); }
    @keyframes blink {
      0%, 100% { opacity: 1; } 50% { opacity: 0.3; }
    }

    /* ‚îÄ‚îÄ AR SCENE WRAPPER ‚îÄ‚îÄ */
    #ar-container {
      position: fixed; inset: 0; z-index: 1;
      display: none;
    }
    #ar-container.active { display: block; }

    /* ‚îÄ‚îÄ DEMO MODE (no real GPS ‚Äî for desktop testing) ‚îÄ‚îÄ */
    #demo-map {
      position: fixed; inset: 0; z-index: 2;
      background: #0d0b08;
      display: none;
      overflow: hidden;
    }
    #demo-map.active { display: block; }
    .demo-label {
      position: absolute; top: 1rem; left: 50%;
      transform: translateX(-50%);
      font-size: 0.65rem; letter-spacing: 0.15em;
      color: rgba(201,168,76,0.5);
      background: rgba(10,7,5,0.8);
      padding: 0.3rem 1rem;
      border: 1px solid rgba(201,168,76,0.2);
      z-index: 10;
      pointer-events: none;
    }
    canvas#map-canvas {
      width: 100%; height: 100%;
    }

    /* scrollbar for POI */
    ::-webkit-scrollbar { width: 4px; }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb { background: rgba(201,168,76,0.3); }
  </style>
</head>
<body>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
     LOADING / START SCREEN
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="loading-screen">
  <div class="loading-emblem">
    <!-- Templar cross SVG -->
    <svg viewBox="0 0 60 60" fill="none" xmlns="http://www.w3.org/2000/svg">
      <path d="M30 5 L30 55 M5 30 L55 30" stroke="#c9a84c" stroke-width="3" stroke-linecap="round"/>
      <path d="M30 5 L30 55 M5 30 L55 30" stroke="#c9a84c" stroke-width="3" stroke-linecap="round" opacity="0.3" transform="rotate(45 30 30)"/>
      <circle cx="30" cy="30" r="6" fill="#c9a84c" opacity="0.6"/>
    </svg>
  </div>

  <div>
    <div class="loading-title">LENDAS<br/>DE PORTUGAL</div>
    <div class="loading-subtitle" style="margin-top:0.5rem">Uncover the secrets of the old empire</div>
  </div>

  <button class="start-btn" id="start-btn">BEGIN THE QUEST</button>

  <div style="font-size:0.65rem; color:rgba(232,217,176,0.25); text-align:center; max-width:260px; line-height:1.6;">
    Requires camera & GPS access.<br/>
    Works best outdoors on mobile Chrome.
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
     DEMO MAP (desktop / no GPS fallback)
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="demo-map">
  <div class="demo-label">‚öî DEMO MODE ‚Äî Walk around to test the quest</div>
  <canvas id="map-canvas"></canvas>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
     AR CONTAINER (mobile with GPS)
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="ar-container">
  <!-- AR.js A-Frame scene injected here by JS -->
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
     GAME UI (overlaid on both AR and demo)
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="game-ui">
  <div class="top-bar">
    <div>
      <div class="game-title">LENDAS DE PORTUGAL</div>
      <div class="gps-status" style="position:relative;top:auto;left:auto;margin-top:0.4rem">
        <div class="gps-dot searching" id="gps-dot"></div>
        <span id="gps-label">Locating...</span>
      </div>
      <div id="debug-box" style="margin-top:0.3rem;font-size:0.55rem;color:rgba(201,168,76,0.65);line-height:1.7;font-family:monospace;"></div>
    </div>
    <div class="score-area">
      <div class="score-label">Tokens Earned</div>
      <div class="score-value" id="token-count">‚öú 0</div>
    </div>
  </div>

  <div class="compass">
    <div class="compass-ring">
      <span class="compass-label">N</span>
      <div class="compass-needle" id="compass-needle"></div>
    </div>
  </div>

  <div class="quest-panel">
    <div class="quest-tag">Active Quest</div>
    <div class="quest-name" id="quest-name">The Templar Cipher</div>
    <div class="quest-desc" id="quest-desc">
      "Seek the ancient seal hidden near the old fortress walls. The knights buried their secrets where the river meets the stone."
    </div>

    <div class="distance-bar-wrap">
      <div class="distance-label">Distance</div>
      <div class="distance-bar">
        <div class="distance-fill" id="dist-fill"></div>
      </div>
      <div class="distance-val" id="dist-val">‚Äî m</div>
    </div>

    <div class="poi-list" id="poi-list"></div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
     FOUND POPUP
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="found-popup">
  <div class="found-glow" id="found-icon">üóùÔ∏è</div>
  <div class="found-title" id="found-title">SECRET DISCOVERED</div>
  <div class="found-desc" id="found-desc">You have uncovered a fragment of the old empire's hidden truth.</div>
  <div>
    <div class="found-reward-label">TOKENS AWARDED</div>
    <div class="found-reward" id="found-reward">+50 ‚öú</div>
  </div>
  <button class="found-btn" id="found-close">CONTINUE THE QUEST</button>
</div>


<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
     SCRIPTS
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<script>
// ‚îÄ‚îÄ GAME DATA ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const QUESTS = [
  {
    id: 'templar_seal',
    name: 'The Templar Cipher',
    icon: '‚öîÔ∏è',
    desc: '"Seek the ancient seal hidden near the old fortress walls. The knights buried their secrets where the river meets the stone."',
    lore: 'You found a Templar seal, marked with the cross of the warrior monks who once guarded Portugal\'s eastern frontier.',
    tokens: 50,
    radius: 30, // metres ‚Äî trigger distance
    color: '#c9a84c',
    // DEMO position offset from user start (metres)
    demoOffset: { x: 120, y: -80 }
  },
  {
    id: 'moorish_scroll',
    name: 'The Moorish Scroll',
    icon: 'üìú',
    desc: '"In the shadow of the minaret that was turned to a church, a scroll waits for eyes that dare to read the old tongue."',
    lore: 'An ancient Arabic scroll describes the city as it was before the Reconquista ‚Äî vibrant markets, fountains, a living city.',
    tokens: 75,
    radius: 30,
    color: '#4a8a9a',
    demoOffset: { x: -90, y: 150 }
  },
  {
    id: 'navigator_compass',
    name: 'The Navigator\'s Compass',
    icon: 'üß≠',
    desc: '"Where the caravels were born, a compass points not north but inward. Find it before the tide erases the mark."',
    lore: 'A brass compass used by a navigator of the Age of Discovery ‚Äî it still points toward the unknown.',
    tokens: 100,
    radius: 30,
    color: '#9a6a3a',
    demoOffset: { x: 200, y: 100 }
  },
  {
    id: 'jewish_star',
    name: 'The Hidden Star',
    icon: '‚ú°Ô∏è',
    desc: '"In the old Judiaria, carved into the stone where hands once lit hidden candles ‚Äî a six-pointed star endures."',
    lore: 'A Star of David carved secretly by conversos during the Inquisition, hidden in plain sight for five centuries.',
    tokens: 80,
    radius: 30,
    color: '#7a9a4a',
    demoOffset: { x: -150, y: -120 }
  }
];

// ‚îÄ‚îÄ STATE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let tokens = 0;
let foundIds = new Set();
let activeQuestIdx = 0;
let userLat = null, userLng = null;
let userX = 0, userY = 0; // demo coords
let demoMode = false;
let questPositions = []; // filled after we know user position
let compassAngle = 0;

// ‚îÄ‚îÄ START ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
document.getElementById('start-btn').addEventListener('click', startGame);

function startGame() {
  document.getElementById('loading-screen').classList.add('hidden');
  setTimeout(() => document.getElementById('loading-screen').style.display = 'none', 900);

  document.getElementById('game-ui').classList.add('active');

  // Detect iOS ‚Äî AR.js doesn't work reliably on iOS, use demo map + real GPS
  const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);

  if (navigator.geolocation) {
    navigator.geolocation.watchPosition(onGPS, onGPSError, {
      enableHighAccuracy: true, maximumAge: 2000, timeout: 8000
    });
    // Give GPS 4 seconds to lock, then fallback
    setTimeout(() => {
      if (!userLat) activateDemoMode();
    }, 4000);
  } else {
    activateDemoMode();
  }

  // On iOS: always use the map view (real GPS coords, no AR camera)
  if (isIOS) {
    document.getElementById('demo-map').classList.add('active');
    // override initQuestPositions to use real GPS but map display
    window._forceMapMode = true;
  }
}

let gpsCallCount = 0;

function onGPS(pos) {
  gpsCallCount++;
  userLat = pos.coords.latitude;
  userLng = pos.coords.longitude;

  document.getElementById('gps-dot').classList.remove('searching');
  document.getElementById('gps-label').textContent = `GPS ¬±${Math.round(pos.coords.accuracy)}m`;

  // Debug info
  const debug = document.getElementById('debug-box');
  if (debug) {
    debug.innerHTML = `
      updates: ${gpsCallCount}<br>
      lat: ${userLat.toFixed(6)}<br>
      lng: ${userLng.toFixed(6)}<br>
      originSet: ${!!originLat}<br>
      x: ${userX.toFixed(1)}m &nbsp; y: ${userY.toFixed(1)}m
    `;
  }

  // First lock ‚Äî store origin and init
  if (!originLat) {
    originLat = userLat;
    originLng = userLng;
    userX = 0;
    userY = 0;
    initQuestPositions();
    return;
  }

  // Absolute offset from origin in metres
  userX = (userLng - originLng) * 111320 * Math.cos(originLat * Math.PI / 180);
  userY = -((userLat - originLat) * 111320);

  updateGameUI();
  if (window._forceMapMode || demoMode) drawMap();
}

function onGPSError() {
  if (!demoMode) activateDemoMode();
}

function activateDemoMode() {
  demoMode = true;
  userLat = 38.7169; userLng = -9.1399; // Lisbon placeholder
  userX = 0; userY = 0;
  document.getElementById('gps-dot').classList.remove('searching');
  document.getElementById('gps-dot').style.background = '#c9a84c';
  document.getElementById('gps-label').textContent = 'Demo Mode';

  document.getElementById('demo-map').classList.add('active');
  initQuestPositions();
  startDemoLoop();
  initCanvas();
}

// ‚îÄ‚îÄ QUEST POSITIONS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function initQuestPositions() {
  if (demoMode) {
    questPositions = QUESTS.map(q => ({
      x: q.demoOffset.x,
      y: q.demoOffset.y
    }));
  } else {
    // Place quests at real GPS offsets (~100-200m each direction)
    questPositions = QUESTS.map(q => ({
      lat: userLat + (q.demoOffset.y / 111320),
      lng: userLng + (q.demoOffset.x / (111320 * Math.cos(userLat * Math.PI / 180))),
      // Also store as relative x/y for map drawing
      x: q.demoOffset.x,
      y: q.demoOffset.y
    }));

    if (!window._forceMapMode) {
      injectARScene();
    } else {
      // iOS: show map with real GPS movement
      initCanvas();
    }
  }
  buildPOIList();
  updateGameUI();
}

// ‚îÄ‚îÄ GPS DISTANCE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function haversine(lat1, lng1, lat2, lng2) {
  const R = 6371000;
  const dLat = (lat2 - lat1) * Math.PI / 180;
  const dLng = (lng2 - lng1) * Math.PI / 180;
  const a = Math.sin(dLat/2)**2 + Math.cos(lat1*Math.PI/180) * Math.cos(lat2*Math.PI/180) * Math.sin(dLng/2)**2;
  return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
}

function getDistance(idx) {
  if (!questPositions[idx]) return 9999;
  if (demoMode) {
    const dx = questPositions[idx].x - userX;
    const dy = questPositions[idx].y - userY;
    return Math.sqrt(dx*dx + dy*dy);
  } else {
    // Always use real GPS haversine when we have coordinates
    return haversine(userLat, userLng, questPositions[idx].lat, questPositions[idx].lng);
  }
}

// ‚îÄ‚îÄ UI ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function buildPOIList() {
  const list = document.getElementById('poi-list');
  list.innerHTML = '';
  QUESTS.forEach((q, i) => {
    const card = document.createElement('div');
    card.className = 'poi-card' + (i === activeQuestIdx ? ' active' : '') + (foundIds.has(q.id) ? ' found' : '');
    card.innerHTML = `
      <div class="poi-icon">${q.icon}</div>
      <div class="poi-name">${q.name}</div>
      <div class="poi-dist" id="poi-dist-${i}">‚Äî m</div>
      ${foundIds.has(q.id) ? '<div class="poi-found-badge">‚úì FOUND</div>' : ''}
    `;
    card.addEventListener('click', () => { activeQuestIdx = i; updateGameUI(); buildPOIList(); });
    list.appendChild(card);
  });
}

function updateGameUI() {
  const q = QUESTS[activeQuestIdx];
  document.getElementById('quest-name').textContent = q.name;
  document.getElementById('quest-desc').textContent = q.desc;
  document.getElementById('token-count').textContent = `‚öú ${tokens}`;

  // Update all distances
  QUESTS.forEach((_, i) => {
    const d = getDistance(i);
    const el = document.getElementById(`poi-dist-${i}`);
    if (el) el.textContent = d < 9999 ? `${Math.round(d)} m` : '‚Äî m';
  });

  // Active quest distance bar
  const dist = getDistance(activeQuestIdx);
  const maxDist = 300;
  const progress = Math.max(0, Math.min(100, 100 - (dist / maxDist * 100)));
  document.getElementById('dist-fill').style.width = progress + '%';
  document.getElementById('dist-val').textContent = dist < 9999 ? `${Math.round(dist)} m` : '‚Äî m';

  // Check proximity
  if (!foundIds.has(q.id) && dist < q.radius) {
    triggerFound(activeQuestIdx);
  }
}

function triggerFound(idx) {
  const q = QUESTS[idx];
  foundIds.add(q.id);
  tokens += q.tokens;

  document.getElementById('found-icon').textContent = q.icon;
  document.getElementById('found-title').textContent = q.name.toUpperCase();
  document.getElementById('found-desc').textContent = q.lore;
  document.getElementById('found-reward').textContent = `+${q.tokens} ‚öú`;
  document.getElementById('found-popup').classList.add('show');

  buildPOIList();
  updateGameUI();
}

document.getElementById('found-close').addEventListener('click', () => {
  document.getElementById('found-popup').classList.remove('show');
  // Auto-select next unfound quest
  for (let i = 0; i < QUESTS.length; i++) {
    if (!foundIds.has(QUESTS[i].id)) { activeQuestIdx = i; break; }
  }
  updateGameUI();
  buildPOIList();
});

// ‚îÄ‚îÄ DEMO LOOP ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let keys = {};
document.addEventListener('keydown', e => keys[e.key] = true);
document.addEventListener('keyup', e => keys[e.key] = false);

// Touch movement for mobile demo
let touchStart = null;
document.addEventListener('touchstart', e => {
  touchStart = { x: e.touches[0].clientX, y: e.touches[0].clientY };
}, { passive: true });
document.addEventListener('touchmove', e => {
  if (!touchStart || !demoMode) return;
  const dx = e.touches[0].clientX - touchStart.x;
  const dy = e.touches[0].clientY - touchStart.y;
  userX += dx * 0.3;
  userY += dy * 0.3;
  touchStart = { x: e.touches[0].clientX, y: e.touches[0].clientY };
  updateGameUI();
  drawMap();
}, { passive: true });

function startDemoLoop() {
  const speed = 2;
  setInterval(() => {
    let moved = false;
    if (keys['ArrowUp'] || keys['w']) { userY -= speed; moved = true; }
    if (keys['ArrowDown'] || keys['s']) { userY += speed; moved = true; }
    if (keys['ArrowLeft'] || keys['a']) { userX -= speed; moved = true; }
    if (keys['ArrowRight'] || keys['d']) { userX += speed; moved = true; }
    if (moved) { updateGameUI(); drawMap(); }
  }, 30);
}

// ‚îÄ‚îÄ CANVAS MAP (demo mode) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function initCanvas() {
  const canvas = document.getElementById('map-canvas');
  resizeCanvas(canvas);
  window.addEventListener('resize', () => resizeCanvas(canvas));
  drawMap();
}

function resizeCanvas(canvas) {
  canvas.width = window.innerWidth;
  canvas.height = window.innerHeight;
  drawMap();
}

function drawMap() {
  const canvas = document.getElementById('map-canvas');
  const ctx = canvas.getContext('2d');
  const W = canvas.width, H = canvas.height;
  const cx = W / 2, cy = H / 2;
  const scale = 1.5; // pixels per metre

  ctx.clearRect(0, 0, W, H);

  // background grid
  ctx.strokeStyle = 'rgba(201,168,76,0.04)';
  ctx.lineWidth = 1;
  const gridSize = 40;
  const offX = ((cx - userX * scale) % gridSize + gridSize) % gridSize;
  const offY = ((cy - userY * scale) % gridSize + gridSize) % gridSize;
  for (let x = offX; x < W; x += gridSize) {
    ctx.beginPath(); ctx.moveTo(x, 0); ctx.lineTo(x, H); ctx.stroke();
  }
  for (let y = offY; y < H; y += gridSize) {
    ctx.beginPath(); ctx.moveTo(0, y); ctx.lineTo(W, y); ctx.stroke();
  }

  // draw quest markers
  QUESTS.forEach((q, i) => {
    const qx = cx + (questPositions[i].x - userX) * scale;
    const qy = cy + (questPositions[i].y - userY) * scale;
    const found = foundIds.has(q.id);
    const active = i === activeQuestIdx;
    const dist = getDistance(i);

    // pulse ring for active
    if (active && !found) {
      const pulse = 0.5 + 0.5 * Math.sin(Date.now() / 400);
      ctx.beginPath();
      ctx.arc(qx, qy, q.radius * scale * (1 + pulse * 0.5), 0, Math.PI * 2);
      ctx.strokeStyle = `rgba(201,168,76,${0.15 * pulse})`;
      ctx.lineWidth = 1;
      ctx.stroke();
    }

    // trigger radius
    ctx.beginPath();
    ctx.arc(qx, qy, q.radius * scale, 0, Math.PI * 2);
    ctx.strokeStyle = found ? 'rgba(74,154,90,0.3)' : (active ? 'rgba(201,168,76,0.3)' : 'rgba(201,168,76,0.1)');
    ctx.lineWidth = 1;
    ctx.stroke();
    ctx.fillStyle = found ? 'rgba(74,154,90,0.05)' : (active ? 'rgba(201,168,76,0.05)' : 'transparent');
    ctx.fill();

    // marker
    ctx.beginPath();
    ctx.arc(qx, qy, 12, 0, Math.PI * 2);
    ctx.fillStyle = found ? '#1a4a2a' : (active ? 'rgba(201,168,76,0.2)' : 'rgba(20,15,10,0.8)');
    ctx.fill();
    ctx.strokeStyle = found ? '#4a9a5a' : (active ? '#c9a84c' : 'rgba(201,168,76,0.4)');
    ctx.lineWidth = active ? 2 : 1;
    ctx.stroke();

    // icon
    ctx.font = '14px serif';
    ctx.textAlign = 'center';
    ctx.textBaseline = 'middle';
    ctx.fillText(q.icon, qx, qy);

    // label
    ctx.font = '10px Crimson Pro, serif';
    ctx.fillStyle = found ? '#4a9a5a' : (active ? '#c9a84c' : 'rgba(201,168,76,0.5)');
    ctx.textAlign = 'center';
    ctx.textBaseline = 'top';
    ctx.fillText(q.name, qx, qy + 16);

    // distance line to active
    if (active && !found) {
      ctx.beginPath();
      ctx.moveTo(cx, cy);
      ctx.lineTo(qx, qy);
      ctx.strokeStyle = 'rgba(201,168,76,0.15)';
      ctx.lineWidth = 1;
      ctx.setLineDash([4, 6]);
      ctx.stroke();
      ctx.setLineDash([]);
    }
  });

  // user marker
  ctx.beginPath();
  ctx.arc(cx, cy, 8, 0, Math.PI * 2);
  ctx.fillStyle = 'rgba(201,168,76,0.9)';
  ctx.fill();
  ctx.beginPath();
  ctx.arc(cx, cy, 14, 0, Math.PI * 2);
  ctx.strokeStyle = 'rgba(201,168,76,0.3)';
  ctx.lineWidth = 2;
  ctx.stroke();

  // user direction arrow
  ctx.save();
  ctx.translate(cx, cy);
  ctx.rotate(compassAngle);
  ctx.beginPath();
  ctx.moveTo(0, -20);
  ctx.lineTo(5, -8);
  ctx.lineTo(-5, -8);
  ctx.closePath();
  ctx.fillStyle = 'rgba(201,168,76,0.5)';
  ctx.fill();
  ctx.restore();

  // instructions
  ctx.font = '11px Crimson Pro, serif';
  ctx.fillStyle = 'rgba(201,168,76,0.3)';
  ctx.textAlign = 'center';
  ctx.textBaseline = 'top';
  ctx.fillText('Arrow keys / WASD to move  ‚Ä¢  Touch drag on mobile', W / 2, 60);

  requestAnimationFrame(drawMap);
}

// ‚îÄ‚îÄ AR SCENE (real GPS mode) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function injectARScene() {
  // Load A-Frame + AR.js dynamically
  const aframeScript = document.createElement('script');
  aframeScript.src = 'https://aframe.io/releases/1.6.0/aframe.min.js';
  document.head.appendChild(aframeScript);

  aframeScript.onload = () => {
    const arScript = document.createElement('script');
    arScript.src = 'https://raw.githack.com/AR-js-org/AR.js/3.4.7/aframe/build/aframe-ar.js';
    document.head.appendChild(arScript);

    arScript.onload = () => buildARScene();
  };
}

function buildARScene() {
  const container = document.getElementById('ar-container');
  container.classList.add('active');

  let entitiesHTML = '';
  QUESTS.forEach((q, i) => {
    if (!questPositions[i]) return;
    entitiesHTML += `
      <a-text
        value="${q.icon} ${q.name}"
        look-at="[gps-new-camera]"
        scale="40 40 40"
        color="${q.color}"
        gps-new-entity-place="latitude: ${questPositions[i].lat}; longitude: ${questPositions[i].lng};"
      ></a-text>
      <a-sphere
        radius="3"
        color="${q.color}"
        opacity="0.6"
        gps-new-entity-place="latitude: ${questPositions[i].lat}; longitude: ${questPositions[i].lng};"
      ></a-sphere>
    `;
  });

  container.innerHTML = `
    <a-scene
      vr-mode-ui="enabled: false"
      arjs="sourceType: webcam; videoTexture: true; debugUIEnabled: false"
      renderer="antialias: true; alpha: true"
      style="position:absolute;inset:0;width:100%;height:100%;">
      <a-camera gps-new-camera="gpsMinDistance: 2"></a-camera>
      ${entitiesHTML}
    </a-scene>
  `;
}

// ‚îÄ‚îÄ DEVICE ORIENTATION (compass) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
window.addEventListener('deviceorientationabsolute', e => {
  if (e.alpha !== null) {
    compassAngle = e.alpha * Math.PI / 180;
    document.getElementById('compass-needle').style.transform = `rotate(${e.alpha}deg)`;
  }
}, true);

// Simulate slow drift in demo for visual life
if (!window.DeviceOrientationEvent) {
  setInterval(() => {
    compassAngle += 0.005;
    document.getElementById('compass-needle').style.transform = `rotate(${compassAngle * 180 / Math.PI}deg)`;
  }, 50);
}
</script>
</body>
</html>
